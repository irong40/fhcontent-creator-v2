---
phase: 03-webhook-security
plan: "03-03"
type: execute
wave: 3
depends_on:
  - "03-02"
files_modified:
  - D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md
autonomous: true
requirements:
  - SEC-04
  - SEC-05

must_haves:
  truths:
    - "ROTATION.md exists at D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md"
    - "Document covers all 6 rotation steps in order"
    - "Document confirms SEC-04: n8n port 5678 is loopback-only"
    - "Document confirms SEC-05: CRON_SECRET header validation procedure during transition"
    - "Document includes rollback procedure if rotation causes failures"
    - "Document includes the hmac-test.json re-run as the post-rotation verification step"
  artifacts:
    - path: "D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md"
      provides: "Runbook for rotating N8N_WEBHOOK_SECRET without service interruption"
      contains: "ROTATION STEPS"
  key_links:
    - from: "ROTATION.md Step 4"
      to: "D:/n8n/.env"
      via: "N8N_WEBHOOK_SECRET update"
      pattern: "N8N_WEBHOOK_SECRET"
    - from: "ROTATION.md Step 2"
      to: "Supabase Edge Functions"
      via: "supabase secrets set HMAC_SECRET"
      pattern: "supabase secrets set"
---

<objective>
Produce a runbook (ROTATION.md) documenting the procedure for rotating N8N_WEBHOOK_SECRET
without service interruption. This is a documentation-only plan — no n8n UI interaction,
no code changes. The document also confirms that two other security controls are still in place:
SEC-04 (n8n port 5678 bound to loopback only, not 0.0.0.0) and SEC-05 (CRON_SECRET header
validation during the rotation window). The ROTATION.md becomes the authoritative operational
reference for anyone performing secret rotation.
</objective>

<context>
@D:/Projects/fhcontent-creator-v2/.planning/ROADMAP.md
@D:/Projects/fhcontent-creator-v2/.planning/STATE.md
</context>

<tasks>
<task type="auto">
  <name>Task 1: Verify SEC-04 (port 5678 loopback-only binding)</name>
  <files>D:/n8n/docker-compose.yml</files>
  <action>
  Read D:/n8n/docker-compose.yml and confirm the n8n service ports binding.

  SEC-04 requires that port 5678 is bound to 127.0.0.1 only, NOT 0.0.0.0.
  The docker-compose.yml ports entry must look like:
  ```yaml
  ports:
    - "127.0.0.1:5678:5678"
  ```
  NOT:
  ```yaml
  ports:
    - "5678:5678"   # WRONG — binds to all interfaces (0.0.0.0)
  ```

  If the current binding is 0.0.0.0 (or unqualified), document the fix required:
  Change "5678:5678" to "127.0.0.1:5678:5678" in docker-compose.yml, then run:
    docker compose up -d
  This change does NOT interrupt the Cloudflare Tunnel (which connects to localhost:5678
  internally). External access still works through the tunnel.

  Verify current state:
  ```bash
  grep -A 5 "ports:" D:/n8n/docker-compose.yml
  ```

  Also verify at the network level:
  ```bash
  netstat -an | grep 5678
  ```
  If binding is correct, you see: 127.0.0.1:5678 LISTENING
  If binding is wrong, you see: 0.0.0.0:5678 LISTENING

  If SEC-04 is NOT currently in place, fix it NOW (this is a prerequisite for writing
  accurate documentation). Update docker-compose.yml and restart.
  </action>
  <verify>
  ```bash
  netstat -an | grep 5678 | grep LISTENING
  ```
  Must show 127.0.0.1:5678, not 0.0.0.0:5678.
  </verify>
  <done>SEC-04 confirmed: port 5678 is loopback-only. Status documented.</done>
</task>

<task type="auto">
  <name>Task 2: Verify SEC-05 (CRON_SECRET header validation)</name>
  <files>D:/n8n/.env, Supabase Edge Functions</files>
  <action>
  SEC-05 requires that CRON_SECRET is used to authenticate the cron job triggers
  (daily-media, daily-publish, check-status — these were the 3 Vercel cron jobs being replaced).

  Check D:/n8n/.env for CRON_SECRET:
  ```bash
  grep CRON_SECRET D:/n8n/.env
  ```

  If CRON_SECRET is not present in .env, it may be stored in n8n credentials. Check by:
  - Opening n8n → Credentials → search for "cron" or "secret"

  The intent of SEC-05 is that when the 3 cron workflows (Phases 4-6) call back into
  the system or receive external triggers, they validate a CRON_SECRET header to prevent
  unauthorized trigger of paid API calls.

  Document the current state of CRON_SECRET:
  - Is it set in .env?
  - What value (do NOT record the actual value in ROTATION.md — reference it by name)
  - Which workflows use it?
  - How is it validated?

  During a N8N_WEBHOOK_SECRET rotation, CRON_SECRET is separate and does NOT need to change
  unless specifically compromised. ROTATION.md must make this distinction clear.
  </action>
  <verify>
  grep CRON_SECRET D:/n8n/.env returns a non-empty result OR you have documented that
  CRON_SECRET is stored in n8n credentials (and where).
  </verify>
  <done>SEC-05 current state documented. CRON_SECRET location confirmed.</done>
</task>

<task type="auto">
  <name>Task 3: Write ROTATION.md</name>
  <files>D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md</files>
  <action>
  Create the file D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md with the
  following content (adjust SEC-04 and SEC-05 status sections based on what you found
  in Tasks 1 and 2):

  ---
  # N8N_WEBHOOK_SECRET Rotation Runbook

  **Last Updated**: 2026-02-26
  **Applies To**: All n8n workflows that call Supabase Edge Functions with HMAC-SHA256 signatures
  **Affected Secret**: N8N_WEBHOOK_SECRET (stored in D:/n8n/.env)
  **Paired Secret**: HMAC_SECRET (or equivalent) in Supabase Edge Function environment
  **Both secrets must always be identical.**

  ## When to Rotate
  - Immediately if the secret is exposed in logs, commits, or error messages
  - Every 90 days as a routine rotation
  - After any team member with secret access leaves
  - After any suspected compromise of the n8n host or Supabase project

  ## Pre-Rotation Checklist
  - [ ] Confirm all active workflows using HMAC signing are documented below
  - [ ] Schedule rotation during a low-traffic window (content jobs run at 6AM ET)
  - [ ] Have Supabase dashboard and D:/n8n/ access ready
  - [ ] Have the hmac-test.json workflow ready to run post-rotation

  ## Workflows Using HMAC Signing (update this list as new workflows are added)
  - WF-Daily-Media (Phase 4) — calls n8n-topic-callback, n8n-research-callback
  - WF-Daily-Publish (Phase 5) — calls n8n-asset-callback, n8n-publish-callback
  - WF-Status-Check (Phase 6) — calls n8n-topic-callback (status updates)
  - HMAC-Test-All-Functions — test workflow (n8n-workflows/hmac-test.json)

  ## ROTATION STEPS

  ### Step 1: Generate a new secret
  ```bash
  node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
  ```
  Copy the output. This is NEW_SECRET. Keep the old secret available until Step 6.

  ### Step 2: Update Supabase Edge Function secret FIRST
  Update the secret in Supabase BEFORE updating n8n. This creates a brief window where
  Supabase expects the NEW secret but n8n is still sending the OLD secret — the existing
  n8n workflows will return 401 during this window. The window is minimized in Step 4.

  ```bash
  cd D:/Projects/fhcontent-creator-v2
  npx supabase secrets set HMAC_SECRET=<NEW_SECRET> --project-ref qjpujskwqaehxnqypxzu
  ```

  ### Step 3: Redeploy all 4 Edge Functions to pick up the new secret
  Supabase Edge Functions read secrets at deploy time (not dynamically). All 4 must be
  redeployed:

  ```bash
  cd D:/Projects/fhcontent-creator-v2
  npx supabase functions deploy n8n-topic-callback --project-ref qjpujskwqaehxnqypxzu
  npx supabase functions deploy n8n-research-callback --project-ref qjpujskwqaehxnqypxzu
  npx supabase functions deploy n8n-asset-callback --project-ref qjpujskwqaehxnqypxzu
  npx supabase functions deploy n8n-publish-callback --project-ref qjpujskwqaehxnqypxzu
  ```

  Each deploy takes ~30–60 seconds. The function is unavailable for ~5 seconds per deploy.
  Total downtime window: ~2–4 minutes.

  ### Step 4: Update N8N_WEBHOOK_SECRET in D:/n8n/.env
  Open D:/n8n/.env in a text editor. Find the line:
  ```
  N8N_WEBHOOK_SECRET=<OLD_SECRET>
  ```
  Replace it with:
  ```
  N8N_WEBHOOK_SECRET=<NEW_SECRET>
  ```
  Save the file.

  ### Step 5: Update the secret in n8n workflow Set nodes
  Because N8N_BLOCK_ENV_ACCESS_IN_NODE=true, the secret is hard-coded in Set nodes
  within each HMAC-signing workflow. Update the webhookSecret field in each workflow:

  For each workflow listed in "Workflows Using HMAC Signing" above:
  1. Open the workflow in n8n
  2. Find the "Set Secret" node (first node after Manual/Schedule Trigger in the signing chain)
  3. Update the webhookSecret value to NEW_SECRET
  4. Save the workflow (Ctrl+S)

  NOTE: This step requires human interaction in the n8n UI. There is no CLI shortcut.
  If you have many workflows, use the n8n API to update workflow JSON directly:
  ```bash
  # Export current workflow
  curl -s "http://localhost:5678/api/v1/workflows/<WORKFLOW_ID>" \
    -H "X-N8N-API-KEY: $(grep N8N_API_KEY D:/n8n/.env | cut -d= -f2)" \
    > /tmp/wf_backup.json

  # Edit the JSON to replace OLD_SECRET with NEW_SECRET
  python3 -c "
  import json, sys
  with open('/tmp/wf_backup.json') as f: wf = json.load(f)
  text = json.dumps(wf)
  text = text.replace('<OLD_SECRET>', '<NEW_SECRET>')
  with open('/tmp/wf_updated.json', 'w') as f: f.write(text)
  print('Done')
  "

  # Push updated workflow back
  curl -s -X PUT "http://localhost:5678/api/v1/workflows/<WORKFLOW_ID>" \
    -H "X-N8N-API-KEY: $(grep N8N_API_KEY D:/n8n/.env | cut -d= -f2)" \
    -H "Content-Type: application/json" \
    -d @/tmp/wf_updated.json
  ```

  ### Step 6: Restart n8n
  ```bash
  cd D:/n8n
  docker compose restart n8n
  ```
  Wait 15 seconds. Verify:
  ```bash
  curl -s -o /dev/null -w "%{http_code}" http://localhost:5678/healthz
  ```
  Expected: 200

  ### Step 7: Verify rotation with hmac-test.json
  In n8n UI, run the HMAC-Test-All-Functions workflow manually.
  All 4 valid-signature tests must return 200.
  All 4 tampered-signature tests must return 401.

  If any valid-signature test returns 401, the secret is out of sync between n8n and Supabase.
  Check: Did you update the Set node in that specific workflow? Did the edge function redeploy?

  ### Step 8: Update exported JSON files in version control
  Re-export all HMAC-signing workflows with the new secret REPLACED by placeholder:
  - D:/Projects/fhcontent-creator-v2/n8n-workflows/hmac-test.json (already sanitized)
  - Any Phase 4-6 workflow JSON files

  Commit the updated JSON files (without the actual secret) to version control.

  ## Post-Rotation Checklist
  - [ ] D:/n8n/.env has NEW_SECRET
  - [ ] All 4 Supabase edge functions deployed with NEW_SECRET
  - [ ] All n8n workflow Set nodes updated with NEW_SECRET
  - [ ] hmac-test workflow passes (all 200 / all 401)
  - [ ] Old secret is no longer stored anywhere
  - [ ] Version control updated with sanitized JSON exports
  - [ ] Rotation date recorded below in Rotation History

  ## Rollback Procedure
  If rotation fails and workflows are returning 401 unexpectedly:

  1. Revert Supabase secret to OLD_SECRET:
     ```bash
     npx supabase secrets set HMAC_SECRET=<OLD_SECRET> --project-ref qjpujskwqaehxnqypxzu
     npx supabase functions deploy <all 4 functions>
     ```

  2. Revert D:/n8n/.env to OLD_SECRET and restart:
     ```bash
     # Edit D:/n8n/.env, restore OLD_SECRET
     docker compose restart n8n
     ```

  3. Revert n8n workflow Set nodes to OLD_SECRET (reverse of Step 5)

  4. Re-run hmac-test workflow to confirm rollback succeeded (all 200 for valid)

  5. Investigate root cause before attempting rotation again

  ## Security Controls Inventory

  ### SEC-04: Port 5678 Loopback-Only Binding
  **Status**: [CONFIRMED / NEEDS FIX — fill in based on Task 1 finding]
  **Evidence**:
  ```
  netstat -an | grep 5678 | grep LISTENING
  # Expected output: 127.0.0.1:5678
  ```
  **Configuration**: D:/n8n/docker-compose.yml, ports section: "127.0.0.1:5678:5678"
  **Why it matters**: If 5678 were bound to 0.0.0.0, anyone on the local network (or via port
  scan) could reach the n8n UI without going through Cloudflare Tunnel. The Cloudflare Tunnel
  connects to 127.0.0.1:5678 internally — loopback binding does not break external access.
  **Re-verify command**: `netstat -an | grep 5678`
  **Does rotation change this?** No. Port binding is a Docker configuration separate from secrets.

  ### SEC-05: CRON_SECRET Header Validation
  **Status**: [ACTIVE / NOT YET IMPLEMENTED — fill in based on Task 2 finding]
  **Location**: [D:/n8n/.env / n8n Credentials — fill in based on Task 2]
  **Why it matters**: The 3 cron workflows (daily-media, daily-publish, check-status) trigger
  paid API calls (Claude, Gemini, ElevenLabs, HeyGen). Without a CRON_SECRET, anyone who can
  POST to the n8n webhook URL can trigger these calls, incurring costs.
  **Rotation**: CRON_SECRET is independent of N8N_WEBHOOK_SECRET. Rotate separately only if
  compromised. If rotating CRON_SECRET, update it in D:/n8n/.env and in the n8n workflows
  that validate it (same Set node pattern as N8N_WEBHOOK_SECRET).
  **During N8N_WEBHOOK_SECRET rotation**: CRON_SECRET requires NO changes. The two secrets
  are used for different purposes and are stored independently.
  **Re-verify command**: `grep CRON_SECRET D:/n8n/.env`

  ## Rotation History
  | Date       | Rotated By | Reason            | Verification Result |
  |------------|------------|-------------------|---------------------|
  | 2026-02-26 | Initial    | First provisioning | N/A (first set)    |

  _Add a row each time rotation is performed._
  ---

  Write this content to ROTATION.md, filling in the [CONFIRMED / NEEDS FIX] and
  [ACTIVE / NOT YET IMPLEMENTED] placeholders based on what Tasks 1 and 2 found.
  </action>
  <verify>
  ```bash
  ls -la "D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md"
  ```
  File exists and is > 3000 bytes (substantial content).

  Check required sections present:
  ```bash
  python3 -c "
  with open('D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md') as f:
      content = f.read()
  checks = ['ROTATION STEPS', 'Step 1', 'Step 2', 'Step 3', 'Step 4', 'Step 5', 'Step 6',
            'Step 7', 'Step 8', 'Rollback', 'SEC-04', 'SEC-05', 'CRON_SECRET',
            'Rotation History']
  for c in checks:
      print(c + ':', 'FOUND' if c in content else 'MISSING')
  "
  ```
  All sections must show FOUND.
  </verify>
  <done>ROTATION.md written with all required sections, placeholders filled in.</done>
</task>
</tasks>

<verification>
Final verification checklist:

1. File exists:
   ls -la "D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md"
   -- File > 3000 bytes

2. All rotation steps present:
   grep -c "^### Step" "D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md"
   -- Returns 8 (Steps 1-8)

3. Both security controls documented:
   grep -c "SEC-0[45]" "D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md"
   -- Returns >= 4 (each control mentioned multiple times)

4. Rollback procedure present:
   grep -c "Rollback" "D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md"
   -- Returns >= 2

5. No actual secrets in the document:
   python3 -c "
   import re
   with open('D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md') as f:
       content = f.read()
   secrets = re.findall(r'[0-9a-f]{64}', content)
   print('Secrets found (should be 0):', len(secrets))
   "
   -- Returns 0

6. SEC-04 status is not placeholder text:
   grep "SEC-04" "D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md" | grep -v "CONFIRMED\|NEEDS FIX"
   -- Returns empty (placeholder was replaced with actual status)
</verification>

<success_criteria>
- ROTATION.md exists at D:/Projects/fhcontent-creator-v2/n8n-workflows/ROTATION.md
- Document contains all 8 rotation steps with specific commands
- Rollback procedure documented
- Post-rotation verification step references hmac-test.json workflow
- SEC-04 status confirmed (loopback binding) with re-verify command
- SEC-05 status confirmed (CRON_SECRET location and scope) with re-verify command
- Rotation History table initialized with initial provisioning entry
- No actual secret values in the document
- All placeholder text [CONFIRMED/NEEDS FIX] replaced with actual current status
</success_criteria>

<output>
After completion, create summary file:
D:/Projects/fhcontent-creator-v2/.planning/phases/03-webhook-security/03-03-SUMMARY.md

Include:
- SEC-04 status: CONFIRMED or remediated (and what change was required)
- SEC-05 status: ACTIVE or planned (and where CRON_SECRET lives)
- ROTATION.md file size in bytes
- Any gaps discovered during documentation that require future work
- Phase 3 overall completion status (all 3 plans complete = Phase 3 DONE)
</output>
