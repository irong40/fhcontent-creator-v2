---
phase: 02-error-infrastructure
plan: "02-02"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - D:/Projects/fhcontent-creator-v2/n8n-workflows/wf-error-handler.json
autonomous: false
requirements:
  - ERR-01
  - ERR-02

must_haves:
  truths:
    - "WF-Error-Handler workflow exists in n8n and is active"
    - "Workflow is set as the global error workflow in n8n Settings"
    - "Error Trigger node fires when any workflow in the instance fails"
    - "pipeline_errors table receives a row for every workflow failure"
    - "Slack (or n8n internal) notification fires on each error"
    - "wf-error-handler.json is exported and committed to n8n-workflows/"
  artifacts:
    - path: "D:/Projects/fhcontent-creator-v2/n8n-workflows/wf-error-handler.json"
      provides: "Exportable n8n workflow JSON for WF-Error-Handler"
      contains: "\"type\": \"n8n-nodes-base.errorTrigger\""
  key_links:
    - from: "n8n Error Trigger"
      to: "pipeline_errors table"
      via: "Supabase node HTTP POST /rest/v1/pipeline_errors"
      pattern: "pipeline_errors"
    - from: "Set node"
      to: "Error Trigger output"
      via: "expression mapping $workflow.name, $node.name, $execution.id"
      pattern: "$workflow.name"
---

<objective>
Build the global error handler workflow in n8n. When any workflow in the instance fails,
the Error Trigger fires automatically. This workflow captures structured error data into
pipeline_errors via Supabase, then sends a Slack notification (or falls back to n8n's built-in
notification if Slack is not yet configured). Once activated and set as the global error workflow,
all unhandled failures across every future workflow are automatically logged.
</objective>

<context>
@D:/Projects/fhcontent-creator-v2/.planning/ROADMAP.md
@D:/Projects/fhcontent-creator-v2/.planning/STATE.md
</context>

<tasks>
<task type="auto">
  <name>Task 1: Build WF-Error-Handler workflow in n8n UI</name>
  <files>n8n UI at http://localhost:5678</files>
  <action>
  Open http://localhost:5678 in a browser. Create a new workflow named exactly "WF-Error-Handler".

  ADD NODE 1 — Error Trigger:
  - Type: Error Trigger (built-in n8n node)
  - This node fires automatically when any OTHER workflow in the n8n instance fails
  - No configuration required — it receives the error context automatically
  - Output fields available: $json.workflow.id, $json.workflow.name, $json.node.name,
    $json.error.message, $json.execution.id, $json.execution.url

  ADD NODE 2 — Set (named "Extract Error Fields"):
  - Type: Set node
  - Mode: Manual mapping
  - Set the following fields (all as expressions):
    - workflow_name  →  {{ $json.workflow.name }}
    - node_name      →  {{ $json.node.name }}
    - error_message  →  {{ $json.error.message }}
    - execution_id   →  {{ $json.execution.id }}
    - correlation_id →  {{ $json.execution.id }}
    - occurred_at    →  {{ $now.toISO() }}
  - Connect Error Trigger → Extract Error Fields

  ADD NODE 3 — Supabase (named "Log to pipeline_errors"):
  - Type: Supabase node (n8n-nodes-base.supabase)
  - Credential: "Supabase Service Role" (already configured in Phase 1)
  - Operation: Create
  - Table Name: pipeline_errors
  - Fields to Send: Choose from fields below (map from previous node):
    - workflow_name  →  {{ $json.workflow_name }}
    - node_name      →  {{ $json.node_name }}
    - error_message  →  {{ $json.error_message }}
    - execution_id   →  {{ $json.execution_id }}
    - correlation_id →  {{ $json.correlation_id }}
  - Connect Extract Error Fields → Log to pipeline_errors

  ADD NODE 4 — HTTP Request (named "Notify Slack"):
  - Type: HTTP Request node
  - Method: POST
  - URL: Use the Slack incoming webhook URL from n8n credentials, OR if Slack not configured,
    use a placeholder URL and disable this node for now (right-click → Disable)
  - Body Content Type: JSON
  - Body (raw JSON):
    ```json
    {
      "text": "n8n workflow error",
      "blocks": [
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*Workflow Failed*: `{{ $('Extract Error Fields').item.json.workflow_name }}`\n*Node*: `{{ $('Extract Error Fields').item.json.node_name }}`\n*Error*: {{ $('Extract Error Fields').item.json.error_message }}\n*Execution*: {{ $('Extract Error Fields').item.json.execution_id }}"
          }
        }
      ]
    }
    ```
  - Continue on Fail: true (Slack failure must NOT prevent error logging)
  - Connect Log to pipeline_errors → Notify Slack

  IMPORTANT: On the "Log to pipeline_errors" Supabase node, set "Continue On Error" to true.
  Error logging must never itself cause an error loop.

  Save the workflow with Ctrl+S.
  </action>
  <verify>
  Workflow "WF-Error-Handler" appears in the workflow list. Node count = 4. Status = inactive
  (will be activated in Task 3 after setting as global error workflow).
  </verify>
  <done>Workflow exists in n8n with all 4 nodes connected in sequence.</done>
</task>

<task type="auto">
  <name>Task 2: Set WF-Error-Handler as the global error workflow</name>
  <files>n8n Settings UI</files>
  <action>
  In n8n, navigate to: Settings (gear icon, bottom-left) → Workflow Settings → Error Workflow.

  NOTE: This is the INSTANCE-LEVEL error workflow, not a per-workflow setting.
  The path in n8n 2.9.0 is:
    Settings → General → "Error Workflow" dropdown

  Select "WF-Error-Handler" from the dropdown. Save.

  Then activate WF-Error-Handler:
  - Open the workflow
  - Toggle the Active switch (top-right) to ON
  - The Error Trigger node only fires when the workflow is active

  IMPORTANT: The WF-Error-Handler workflow itself is EXCLUDED from triggering itself
  (n8n prevents error-handler self-loops by design).
  </action>
  <verify>
  In n8n Settings → General, the Error Workflow field shows "WF-Error-Handler".
  The workflow toggle in the workflow list shows Active (green).
  </verify>
  <done>WF-Error-Handler is active and registered as the global error workflow.</done>
</task>

<task type="auto">
  <name>Task 3: Test with a deliberately broken workflow</name>
  <files>n8n UI</files>
  <action>
  Create a temporary test workflow named "TEST-Error-Trigger" (delete after test):

  - ADD NODE: Manual Trigger
  - ADD NODE: Code node
    - JavaScript:
      ```javascript
      throw new Error("Intentional test error from 02-02 plan verification");
      ```
  - Connect Manual Trigger → Code node
  - Save and activate the workflow
  - Click "Execute Workflow" (or run manually)
  - The Code node will throw, causing the workflow to fail
  - n8n should automatically invoke WF-Error-Handler

  Wait 5–10 seconds, then check:
  1. In Supabase SQL editor, run:
     ```sql
     SELECT workflow_name, node_name, error_message, execution_id, occurred_at
     FROM pipeline_errors
     ORDER BY occurred_at DESC
     LIMIT 5;
     ```
  2. Verify a row appears with workflow_name = 'TEST-Error-Trigger' and
     error_message containing 'Intentional test error'

  After verifying, delete the TEST-Error-Trigger workflow.
  </action>
  <verify>
  pipeline_errors table has a row from TEST-Error-Trigger with the expected error message.
  execution_id is populated (not null). occurred_at is within the last 60 seconds.
  </verify>
  <done>End-to-end error capture confirmed: broken workflow → pipeline_errors row.</done>
</task>

<task type="auto">
  <name>Task 4: Export workflow JSON to n8n-workflows/</name>
  <files>D:/Projects/fhcontent-creator-v2/n8n-workflows/wf-error-handler.json</files>
  <action>
  In n8n, open WF-Error-Handler workflow. Click the three-dot menu (top-right) → Download.
  Save as: D:/Projects/fhcontent-creator-v2/n8n-workflows/wf-error-handler.json

  Alternatively, use the n8n API to export:
  ```bash
  curl -s http://localhost:5678/api/v1/workflows \
    -H "X-N8N-API-KEY: $(grep N8N_API_KEY D:/n8n/.env | cut -d= -f2)" \
    | python3 -c "
  import json, sys
  workflows = json.load(sys.stdin)
  for wf in workflows.get('data', []):
      if wf['name'] == 'WF-Error-Handler':
          print(json.dumps(wf, indent=2))
          break
  " > "D:/Projects/fhcontent-creator-v2/n8n-workflows/wf-error-handler.json"
  ```

  Verify the file is valid JSON:
  ```bash
  python3 -c "import json; json.load(open('D:/Projects/fhcontent-creator-v2/n8n-workflows/wf-error-handler.json')); print('Valid JSON')"
  ```
  </action>
  <verify>
  File exists at D:/Projects/fhcontent-creator-v2/n8n-workflows/wf-error-handler.json
  Contains "errorTrigger" string.
  File size > 500 bytes.
  </verify>
  <done>wf-error-handler.json committed to version control location.</done>
</task>
</tasks>

<verification>
Final verification checklist:

1. n8n Settings confirms WF-Error-Handler is the global error workflow
2. Workflow is Active (green toggle)
3. pipeline_errors contains the test row from TEST-Error-Trigger
4. wf-error-handler.json exists at D:/Projects/fhcontent-creator-v2/n8n-workflows/
5. JSON file contains "errorTrigger" node type
6. Slack notification node is either connected (if Slack configured) or disabled (not deleted)
</verification>

<success_criteria>
- WF-Error-Handler workflow is active in n8n
- Set as global error workflow in n8n instance settings
- Error Trigger → Set → Supabase → HTTP Request chain is connected
- Any workflow failure in the n8n instance writes a row to pipeline_errors
- Supabase insert uses the pre-configured "Supabase Service Role" credential
- wf-error-handler.json exported to n8n-workflows/ directory
- Test run produced a verifiable row in pipeline_errors
- Slack notify node has Continue on Fail = true (does not block error logging)
</success_criteria>

<output>
After completion, create summary file:
D:/Projects/fhcontent-creator-v2/.planning/phases/02-error-infrastructure/02-02-SUMMARY.md

Include:
- n8n workflow ID (visible in URL when editing)
- Node names and types in order
- Confirmation of global error workflow setting
- Row inserted during test (workflow_name, error_message snippet)
- Whether Slack node is active or disabled (and why)
</output>
