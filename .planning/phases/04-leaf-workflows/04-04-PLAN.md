---
phase: 04-leaf-workflows
plan: "04-04"
type: execute
wave: 3
depends_on:
  - "04-02"
  - "04-03"
files_modified:
  - vercel.json
  - n8n-workflows/wf5-status-poller.json
autonomous: false
requirements:
  - CUT-01
  - CUT-02

must_haves:
  truths:
    - "WF-5 and Vercel check-status cron run in parallel for at least 48 hours"
    - "Results from both systems are compared daily before cutover"
    - "check-status cron entry is removed from vercel.json only after human confirms parity"
    - "vercel.json is deployed to Vercel after cron removal"
  artifacts:
    - path: "vercel.json"
      provides: "Updated Vercel config with check-status cron removed"
      contains: "\"crons\":"
  key_links:
    - from: "vercel.json crons array"
      to: "Vercel check-status cron"
      via: "Remove entry after 48h parallel run confirms parity"
      pattern: "check-status"
---

<objective>
Safely cut over the 10-minute status polling from Vercel to n8n. Run both systems in parallel for 48 hours, compare outputs, and only remove the Vercel cron once a human confirms the results match. This is a checkpoint plan — the human-verify task requires explicit sign-off before proceeding.
</objective>

<context>
@D:/Projects/fhcontent-creator-v2/.planning/ROADMAP.md
@D:/Projects/fhcontent-creator-v2/.planning/STATE.md
</context>

<tasks>
<task type="auto">
  <name>Task 1: Activate WF-5 in production and confirm Vercel cron still active</name>
  <files>n8n-workflows/wf5-status-poller.json</files>
  <action>
1. In n8n UI, ensure WF-5 Status Poller is **Active** (toggle in top right of workflow editor).
2. Confirm Schedule Trigger is set to every 10 minutes.
3. In Vercel dashboard or vercel.json, confirm `/api/cron/check-status` cron is still present and active.

Current vercel.json cron entry to preserve during parallel run:
```json
{
  "path": "/api/cron/check-status",
  "schedule": "*/10 * * * *"
}
```

4. Add a log marker to distinguish WF-5 runs from Vercel cron runs. In Next.js `/api/cron/check-status`, the route already exists. Note that WF-5 sends `X-Correlation-ID` header and `Authorization: Bearer <CRON_SECRET>` — Vercel cron sends only `Authorization: Bearer <CRON_SECRET>`. The response is the same for both.

5. Document start time of parallel run: record in `n8n-workflows/CUTOVER-LOG.md`:
```markdown
# WF-5 Cutover Log

## Parallel Run Start
- Date: [YYYY-MM-DD HH:MM UTC]
- WF-5 activated: YES
- Vercel check-status cron: ACTIVE
- Expected parallel run end: 48 hours after start

## Comparison Criteria
1. pipeline_runs rows with workflow_id=WF-5 increment every 10 minutes
2. content_pieces status updates match between n8n-triggered and Vercel-triggered executions
3. No duplicate updates (both systems call same route — idempotency required)
4. Error rates comparable (check pipeline_errors)
```
  </action>
  <verify>
- WF-5 shows "Active" in n8n.
- Vercel cron for check-status shows active in Vercel dashboard.
- First WF-5 execution appears in pipeline_runs within 10 minutes.
  </verify>
  <done>Both systems running in parallel. Start time logged.</done>
</task>

<task type="auto">
  <name>Task 2: Monitor parallel run for 48 hours</name>
  <files>n8n-workflows/CUTOVER-LOG.md</files>
  <action>
After 24 hours, query Supabase to compare:

```sql
-- Count WF-5 executions in last 24h
SELECT COUNT(*) as wf5_runs, MIN(started_at), MAX(started_at)
FROM pipeline_runs
WHERE workflow_id = 'WF-5'
  AND started_at > NOW() - INTERVAL '24 hours';

-- Expected: ~144 runs (every 10 min for 24h = 144)
-- Accept: 130-144 (allows for brief outages)

-- Check error rate
SELECT COUNT(*) as errors
FROM pipeline_errors
WHERE workflow_id = 'WF-5'
  AND created_at > NOW() - INTERVAL '24 hours';

-- Check content piece status updates
SELECT status, COUNT(*)
FROM content_pieces
WHERE updated_at > NOW() - INTERVAL '24 hours'
GROUP BY status;
```

Compare content_pieces update counts and status transitions against baseline from the previous 24h (Vercel-only period).

Record findings in `n8n-workflows/CUTOVER-LOG.md`:
```markdown
## 24-Hour Check
- WF-5 run count: [N] / 144 expected
- Errors: [N]
- Content pieces updated: [N]
- Issues observed: [none / describe]
```

After 48 hours, run same queries for the full 48h window.
  </action>
  <verify>CUTOVER-LOG.md updated with 24h and 48h findings.</verify>
  <done>48-hour monitoring data recorded in CUTOVER-LOG.md.</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 3: Human verification — confirm results parity before cutover</name>
  <files>vercel.json</files>
  <action>
STOP. Human review required before proceeding.

Review the following before approving cutover:

1. Open `n8n-workflows/CUTOVER-LOG.md` and confirm:
   - WF-5 run count >= 130 over 48h (90%+ uptime)
   - Error count is 0 or minimal (< 5 errors in 48h)
   - No duplicate content piece updates or data integrity issues

2. Check n8n execution history:
   - Navigate to https://n8n.faithandharmonyllc.com
   - Open WF-5 → Executions tab
   - Confirm consistent "succeeded" status

3. Check Supabase content_pieces for any anomalies:
   - Status transitions look correct
   - No pieces stuck in intermediate states longer than expected

4. If results are satisfactory: approve by confirming "WF-5 parity confirmed" in your response.
5. If issues found: do NOT proceed. Fix issues in WF-5 and extend parallel run by 24h.
  </action>
  <verify>Human confirms in writing that WF-5 results match Vercel cron behavior.</verify>
  <done>Human has explicitly approved cutover. Task 4 may proceed.</done>
</task>

<task type="auto">
  <name>Task 4: Remove check-status cron from vercel.json</name>
  <files>vercel.json</files>
  <action>
After human approval in Task 3:

1. Read current `D:/Projects/fhcontent-creator-v2/vercel.json`.
2. Locate the crons array entry for `/api/cron/check-status`:
```json
{
  "path": "/api/cron/check-status",
  "schedule": "*/10 * * * *"
}
```
3. Remove only this entry from the crons array. Leave `daily-media` and `daily-publish` cron entries intact — those are cut over in Phase 5.
4. The updated crons array should still contain:
```json
"crons": [
  { "path": "/api/cron/daily-media", "schedule": "0 6 * * *" },
  { "path": "/api/cron/daily-publish", "schedule": "0 * * * *" }
]
```
5. Deploy to Vercel: `vercel --prod` from the project directory.
6. Confirm Vercel dashboard shows only 2 cron jobs (daily-media and daily-publish).
7. Update CUTOVER-LOG.md:
```markdown
## Cutover Completed
- Date: [YYYY-MM-DD HH:MM UTC]
- check-status cron removed from vercel.json: YES
- Deployed to Vercel: YES
- WF-5 is now sole owner of status polling
```
  </action>
  <verify>
- `grep "check-status" vercel.json` returns no matches.
- Vercel dashboard shows 2 crons (not 3).
- WF-5 continues running every 10 minutes post-cutover.
- pipeline_runs continues accumulating WF-5 rows.
  </verify>
  <done>check-status Vercel cron removed. WF-5 is sole status poller.</done>
</task>
</tasks>

<verification>
1. vercel.json no longer contains the check-status cron path.
2. Vercel deployment shows 2 active crons (daily-media, daily-publish).
3. WF-5 continues executing every 10 minutes with no disruption.
4. CUTOVER-LOG.md documents start, 24h check, 48h check, and cutover completion.
5. No data integrity issues in content_pieces after cutover.
</verification>

<success_criteria>
- Zero missed status polls in the first 24 hours after Vercel cron removal.
- Human explicitly confirmed parity before cutover.
- vercel.json crons array has exactly 2 entries (daily-media, daily-publish).
- CUTOVER-LOG.md is complete with timestamps for all milestones.
</success_criteria>

<output>D:/Projects/fhcontent-creator-v2/n8n-workflows/CUTOVER-LOG.md</output>
