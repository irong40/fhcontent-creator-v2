---
phase: 04-leaf-workflows
plan: "04-03"
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - n8n-workflows/wf3-research.json
autonomous: true
requirements:
  - WF-03
  - SEC-05

must_haves:
  truths:
    - "WF-3 is a sub-workflow invoked synchronously by WF-1 via Execute Sub-Workflow node"
    - "WF-3 accepts topic_id as input and returns research results"
    - "CRON_SECRET is sent as Authorization header on all Next.js API calls"
    - "HMAC signature is applied before posting to n8n-research-callback"
    - "correlation_id propagates from the parent WF-1 call through all nodes"
    - "WF-3 has no Schedule Trigger — it is purely event-driven"
  artifacts:
    - path: "n8n-workflows/wf3-research.json"
      provides: "Exportable n8n workflow definition for WF-3"
      contains: "WF-3 Research Sub-Workflow"
  key_links:
    - from: "WF-1 Execute Sub-Workflow node"
      to: "WF-3 Execute Workflow Trigger"
      via: "n8n sub-workflow invocation (synchronous, wait=ON)"
      pattern: "wf3-research"
    - from: "WF-3 HTTP Request"
      to: "/api/topics/research"
      via: "CRON_SECRET Authorization header"
      pattern: "topics/research"
    - from: "WF-3 result"
      to: "n8n-research-callback"
      via: "HMAC-signed POST"
      pattern: "n8n-research-callback"
---

<objective>
Build WF-3 (Research Sub-Workflow) as a synchronous n8n sub-workflow. WF-1 will call it via Execute Sub-Workflow with wait=ON, so WF-1 pauses until WF-3 completes. WF-3 takes a topic_id, calls the Next.js research route, posts results to the n8n-research-callback Edge Function with HMAC signing, and returns a completion signal to WF-1. This satisfies SEC-05 (all inter-service calls authenticated) and WF-03.
</objective>

<context>
@D:/Projects/fhcontent-creator-v2/.planning/ROADMAP.md
@D:/Projects/fhcontent-creator-v2/.planning/STATE.md
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create WF-3 with Execute Workflow Trigger</name>
  <files>n8n-workflows/wf3-research.json</files>
  <action>
In n8n UI, create a new workflow named "WF-3 Research Sub-Workflow".

1. Add **Execute Workflow Trigger** node (NOT a Schedule Trigger or Webhook).
   - This is the entry point when called from WF-1 via Execute Sub-Workflow.
   - Node name: "Sub-Workflow Entry"
   - Expected input fields: `topic_id` (string), `correlation_id` (string), `run_id` (string)

2. Add **Code** node named "Validate Input":
```javascript
const { topic_id, correlation_id, run_id } = $input.item.json;

if (!topic_id) {
  throw new Error('WF-3: topic_id is required');
}
if (!correlation_id) {
  throw new Error('WF-3: correlation_id is required');
}

return [{
  json: {
    topic_id,
    correlation_id,
    run_id: run_id || $execution.id,
    started_at: new Date().toISOString()
  }
}];
```

3. Add **HTTP Request** node named "Log Research Start":
   - Method: POST
   - URL: `https://qjpujskwqaehxnqypxzu.supabase.co/rest/v1/pipeline_runs`
   - Auth: Supabase Service Role credential
   - Headers: `apikey`, `Authorization: Bearer`, `Content-Type: application/json`, `Prefer: return=minimal`
   - Body:
```json
{
  "workflow_id": "WF-3",
  "run_id": "={{ $json.run_id }}",
  "correlation_id": "={{ $json.correlation_id }}",
  "topic_id": "={{ $json.topic_id }}",
  "status": "running",
  "started_at": "={{ $json.started_at }}"
}
```
   - Retry On Fail: ON, Max Tries: 3, Wait: 2000ms
  </action>
  <verify>Create workflow in UI. Confirm Execute Workflow Trigger is the entry node type (not a Schedule or Webhook trigger).</verify>
  <done>WF-3 created with Execute Workflow Trigger → Validate Input → Log Research Start.</done>
</task>

<task type="auto">
  <name>Task 2: Call Next.js research API route</name>
  <files>n8n-workflows/wf3-research.json</files>
  <action>
Continue from "Log Research Start":

1. Add **HTTP Request** node named "Call Research Route":
   - Method: POST
   - URL: `https://fhcontent-creator-v2.vercel.app/api/topics/research`
   - Authentication: Header Auth
     - Header Name: `Authorization`
     - Value: `Bearer {{ $credentials["Vercel Cron Secret"].value }}`
   - Additional Headers:
     - `X-Correlation-ID`: `={{ $('Validate Input').item.json.correlation_id }}`
     - `Content-Type`: `application/json`
   - Body:
```json
{
  "topic_id": "={{ $('Validate Input').item.json.topic_id }}",
  "correlation_id": "={{ $('Validate Input').item.json.correlation_id }}"
}
```
   - Timeout: 50000ms (50 seconds — research can be slow with Claude)
   - Retry On Fail: ON, Max Tries: 3, Wait: 4000ms
   - On Error: Continue to error branch

2. Add **IF** node named "Research Succeeded?":
   - Condition: HTTP status code 200-299 OR `$json.success` equals `true`
   - True → Task 3 (post to callback)
   - False → Error handling

3. Error branch: Add **Code** node named "Format Research Error":
```javascript
return [{
  json: {
    workflow_id: 'WF-3',
    topic_id: $('Validate Input').item.json.topic_id,
    correlation_id: $('Validate Input').item.json.correlation_id,
    error_type: 'research_api_failure',
    error_message: $input.item.json.message || $input.item.json.error || 'Research route failed',
    status_code: $input.item.json.statusCode
  }
}];
```
   Then route to **Execute Workflow: WF-Error**.
  </action>
  <verify>
1. Manually trigger WF-3 via Execute Sub-Workflow test mode with a valid topic_id.
2. Confirm Call Research Route returns data.
3. Confirm Research Succeeded? routes to true branch.
  </verify>
  <done>Research route called with CRON_SECRET auth. Success/failure branches defined.</done>
</task>

<task type="auto">
  <name>Task 3: Post results to n8n-research-callback with HMAC</name>
  <files>n8n-workflows/wf3-research.json</files>
  <action>
On the success branch from "Research Succeeded?":

1. Add **Code** node named "Build Research Callback Payload":
```javascript
const researchData = $input.item.json;
const ctx = $('Validate Input').item.json;

const payload = {
  topic_id: ctx.topic_id,
  correlation_id: ctx.correlation_id,
  run_id: ctx.run_id,
  research_result: researchData.research || researchData,
  completed_at: new Date().toISOString()
};

return [{ json: payload }];
```

2. Add **Code** node named "Sign Research Callback":
```javascript
const secret = $credentials["N8N Signing Secret"].value;
const body = JSON.stringify($input.item.json);
const crypto = require('crypto');
const sig = crypto.createHmac('sha256', secret).update(body).digest('hex');

return [{
  json: {
    _payload: body,
    _hmac: `sha256=${sig}`,
    correlation_id: $input.item.json.correlation_id
  }
}];
```

3. Add **HTTP Request** node named "POST to Research Callback":
   - Method: POST
   - URL: `https://qjpujskwqaehxnqypxzu.supabase.co/functions/v1/n8n-research-callback`
   - Headers:
     - `X-N8N-Signature`: `={{ $json._hmac }}`
     - `X-Correlation-ID`: `={{ $json.correlation_id }}`
     - `Content-Type`: `application/json`
     - `Authorization`: `Bearer {{ $credentials["Supabase Service Role"].value }}`
   - Body: `={{ $json._payload }}`
   - Retry On Fail: ON, Max Tries: 3, Wait: 2000ms

4. Add **HTTP Request** node named "Log Research Complete":
   - Method: PATCH
   - URL: `https://qjpujskwqaehxnqypxzu.supabase.co/rest/v1/pipeline_runs?run_id=eq.={{ $('Validate Input').item.json.run_id }}`
   - Supabase auth headers
   - Body: `{ "status": "completed", "completed_at": "={{ new Date().toISOString() }}" }`

5. Add **Code** node named "Return to WF-1":
```javascript
// This is the return value WF-1 receives from Execute Sub-Workflow
return [{
  json: {
    success: true,
    topic_id: $('Validate Input').item.json.topic_id,
    correlation_id: $('Validate Input').item.json.correlation_id,
    completed_at: new Date().toISOString()
  }
}];
```
   This node is the terminal node — its output is what WF-1's Execute Sub-Workflow node receives.
  </action>
  <verify>
1. Create a temporary workflow "WF-3 Test Caller" (delete after testing):
   - Add Manual Trigger → Code node with test input:
     ```javascript
     return [{ json: { topic_id: 'test-topic-uuid-001', correlation_id: 'test-correlation-001', run_id: 'test-run-001' } }];
     ```
   - Add **Execute Sub-Workflow** node: Workflow = "WF-3 Research Sub-Workflow", Wait for Sub-Workflow: ON, pass all fields.
   - Execute and confirm WF-3 completes and returns `success: true` to the caller.
   - Delete "WF-3 Test Caller" after confirming.
2. Confirm n8n-research-callback Edge Function logs show 200 response with valid HMAC.
3. Confirm pipeline_runs row updated to completed for the WF-3 run.
4. Confirm "Return to WF-1" node output contains success: true.
  </verify>
  <done>Research results POSTed to Edge Function with HMAC. Sub-workflow invocation confirmed working synchronously. WF-1 will receive completion signal.</done>
</task>

<task type="auto">
  <name>Task 4: Export WF-3 JSON</name>
  <files>n8n-workflows/wf3-research.json</files>
  <action>
1. In n8n UI: "WF-3 Research Sub-Workflow" → Download.
2. Save to `D:/Projects/fhcontent-creator-v2/n8n-workflows/wf3-research.json`.
3. Verify file contains "Execute Workflow Trigger" node type and "WF-3 Research Sub-Workflow" name.
  </action>
  <verify>`grep "WF-3 Research Sub-Workflow" n8n-workflows/wf3-research.json` returns match.</verify>
  <done>wf3-research.json committed to repo.</done>
</task>
</tasks>

<verification>
1. WF-3 trigger type is Execute Workflow Trigger (not Schedule or Webhook).
2. Call Research Route sends `Authorization: Bearer <CRON_SECRET>` header.
3. n8n-research-callback receives HMAC-signed POST with correct X-N8N-Signature header.
4. correlation_id is present in every node's data throughout WF-3 execution.
5. Execute Sub-Workflow invocation (from test caller) completes synchronously and returns success.
6. pipeline_runs captures WF-3 start and completion with correlation_id.
</verification>

<success_criteria>
- WF-3 operates as a pure sub-workflow with no independent schedule.
- All API calls carry CRON_SECRET authentication header.
- Research callback is HMAC-signed and accepted by Edge Function.
- correlation_id propagates from parent caller through entire WF-3 execution.
- No business logic in n8n — all processing in Next.js /api/topics/research route.
</success_criteria>

<output>D:/Projects/fhcontent-creator-v2/n8n-workflows/wf3-research.json</output>
