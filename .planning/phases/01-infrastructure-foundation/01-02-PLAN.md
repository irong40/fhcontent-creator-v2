---
phase: 01-infrastructure-foundation
plan: "02"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - D:/n8n/.env
  - D:/n8n/cloudflared-config.yml
autonomous: false
requirements:
  - INFRA-03
  - SEC-04
user_setup:
  - service: cloudflare
    why: "Cloudflare Tunnel provides stable public HTTPS URL for n8n webhook callbacks. Requires a domain managed by Cloudflare."
    env_vars:
      - name: CLOUDFLARE_TUNNEL_TOKEN
        source: "Cloudflare Zero Trust dashboard → Networks → Tunnels → Create a tunnel → copy tunnel token"
    dashboard_config:
      - task: "Create a Cloudflare Tunnel"
        location: "dash.cloudflare.com → Zero Trust → Networks → Tunnels → Add a tunnel → Cloudflared → name it 'n8n-prod'"
      - task: "Add public hostname to the tunnel"
        location: "Tunnel config → Public Hostnames tab → Add hostname: subdomain = n8n, domain = your-cloudflare-domain.com, service = http://localhost:5678"
      - task: "Copy the tunnel token"
        location: "Tunnel creation wizard → Step 2 shows the tunnel token — copy the entire token string"

must_haves:
  truths:
    - "Cloudflare Tunnel is running and connected (cloudflared process active)"
    - "The public webhook URL (https://n8n.your-domain.com/) returns an n8n HTTP response"
    - "Port 5678 is NOT directly reachable from the public internet (loopback-only binding confirmed)"
    - "WEBHOOK_URL in D:/n8n/.env is updated from localhost placeholder to the real tunnel URL"
    - "n8n shows the correct public webhook URL in the Webhook node test panel"
  artifacts:
    - path: "D:/n8n/.env"
      provides: "Updated WEBHOOK_URL pointing to Cloudflare Tunnel public hostname"
      contains: "WEBHOOK_URL=https://"
    - path: "D:/n8n/cloudflared-config.yml"
      provides: "Cloudflare Tunnel configuration file for cloudflared daemon"
      contains: "tunnel:"
  key_links:
    - from: "cloudflared daemon"
      to: "n8n container port 5678"
      via: "tunnel config service URL http://localhost:5678"
      pattern: "localhost:5678"
    - from: "D:/n8n/.env WEBHOOK_URL"
      to: "n8n Webhook node public URL display"
      via: "n8n reads WEBHOOK_URL env var for all webhook URL generation"
      pattern: "WEBHOOK_URL=https://"
---

<objective>
Configure a Cloudflare Tunnel to expose n8n webhooks to the public internet via a stable HTTPS URL, and harden the network by confirming port 5678 is inaccessible from outside the machine.

Purpose: Without a stable public URL, Supabase Edge Function callbacks cannot reach n8n, and the WEBHOOK_URL env var will point to localhost making all webhook URLs in the n8n UI broken. Cloudflare Tunnel is free, persistent (URL does not change on restart unlike ngrok), and does not require opening any firewall ports.

Output: Running cloudflared tunnel, updated WEBHOOK_URL in .env, network isolation confirmed.
</objective>

<execution_context>
@C:/Users/redle/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/redle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@D:/Projects/fhcontent-creator-v2/.planning/PROJECT.md
@D:/Projects/fhcontent-creator-v2/.planning/ROADMAP.md
@D:/Projects/fhcontent-creator-v2/.planning/STATE.md
@D:/Projects/fhcontent-creator-v2/.planning/research/STACK.md
@D:/Projects/fhcontent-creator-v2/.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Human setup — Create Cloudflare Tunnel in dashboard</name>
  <action>
Human must create a Cloudflare Tunnel in the Cloudflare Zero Trust dashboard and provide the tunnel token and public URL. This action has no CLI equivalent — the tunnel must be created through the Cloudflare web UI to obtain a tunnel token and configure the public hostname.

A Cloudflare Tunnel requires a domain managed by Cloudflare (registered or transferred). ngrok is NOT an acceptable substitute — URL changes on every restart break stored webhook references.

Steps:
1. Log in to dash.cloudflare.com
2. Go to Zero Trust → Networks → Tunnels
3. Click "Add a tunnel" → select "Cloudflared" → name it "n8n-prod" → click Save
4. On Step 2, copy the ENTIRE tunnel token string (starts with eyJ...)
5. In "Public Hostnames" tab: subdomain = n8n, domain = your-domain.com, service = http://localhost:5678
6. Note the public URL: https://n8n.yourdomain.com
  </action>
  <verify>User has the tunnel token (eyJ... string) and the full public HTTPS URL ready to provide.</verify>
  <done>Tunnel created in Cloudflare dashboard, token and public URL available for next task.</done>
  <what-needed>
A Cloudflare Tunnel requires a domain managed by Cloudflare (registered or transferred). If you do not have a domain with Cloudflare, you must add one before proceeding. ngrok is NOT an acceptable substitute for production — the URL changes on every restart and would break all stored Supabase Edge Function webhook references.

Steps to complete before resuming:
1. Log in to dash.cloudflare.com
2. Go to Zero Trust → Networks → Tunnels
3. Click "Add a tunnel" → select "Cloudflared" → name it "n8n-prod" → click Save
4. On Step 2 of the wizard, you will see a `cloudflared` install command containing your tunnel token. Copy the ENTIRE token string (starts with eyJ...)
5. In "Public Hostnames" tab:
   - Subdomain: n8n
   - Domain: (your Cloudflare-managed domain, e.g., yourdomain.com)
   - Service Type: HTTP
   - URL: localhost:5678
   - Click "Save hostname"
6. Your public webhook base URL will be: https://n8n.yourdomain.com

Have ready before resuming:
- The tunnel token (long eyJ... string)
- The full public URL (https://n8n.yourdomain.com or similar)
  </what-needed>
  <resume-signal>Paste the tunnel token and the full public URL (e.g., "token: eyJhbGci... url: https://n8n.example.com")</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Install cloudflared, write config, start tunnel</name>
  <files>D:/n8n/cloudflared-config.yml</files>
  <action>
Using the tunnel token provided by the user in the checkpoint:

Step 1 — Download cloudflared for Windows:
```bash
# Download cloudflared Windows AMD64 binary to D:/n8n/
curl -L "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -o "D:/n8n/cloudflared.exe"
```

Step 2 — Authenticate and create the tunnel config file:
```bash
# Run cloudflared with the token to authenticate
"D:/n8n/cloudflared.exe" service install <TUNNEL_TOKEN_FROM_USER>
```

Alternatively, write the config file directly (works when token is provided):

Create D:/n8n/cloudflared-config.yml:
```yaml
tunnel: <extract tunnel UUID from token — it is the "id" field in the base64-decoded JWT header>
credentials-file: C:\Users\<USERNAME>\.cloudflared\<TUNNEL-UUID>.json

ingress:
  - hostname: <PUBLIC_URL_HOST_FROM_USER>
    service: http://localhost:5678
  - service: http_status:404
```

Step 3 — Start the tunnel as a background process to test:
```bash
"D:/n8n/cloudflared.exe" tunnel --config "D:/n8n/cloudflared-config.yml" run &
```

Step 4 — Verify the tunnel is connected:
```bash
"D:/n8n/cloudflared.exe" tunnel info
# Should show tunnel status as "HEALTHY" or "OK"
```

Note: For permanent autostart, Plan 01-03 will configure WinSW to manage cloudflared as a Windows service alongside n8n. For now, the tunnel running in the background is sufficient to verify connectivity.

If `cloudflared service install` is used with the token, cloudflared installs itself as a Windows service automatically. In that case, confirm:
```powershell
Get-Service cloudflared
# Should show Status: Running
```
  </action>
  <verify>
1. `curl -s -o /dev/null -w "%{http_code}" https://<PUBLIC_URL>/` — must return 200 or 301 (n8n setup page via tunnel)
2. `curl -v https://<PUBLIC_URL>/ 2>&1 | grep "< HTTP"` — must not return 502/504 (tunnel connected to n8n)
3. Confirm loopback isolation: direct access to the machine's external IP on port 5678 must time out (port is bound to 127.0.0.1 only).
  </verify>
  <done>cloudflared running, public URL returns n8n HTTP response, direct port 5678 access from outside machine is blocked.</done>
</task>

<task type="auto">
  <name>Task 3: Update WEBHOOK_URL in .env and restart n8n</name>
  <files>D:/n8n/.env</files>
  <action>
Update D:/n8n/.env: replace the localhost placeholder with the real tunnel URL.

Find the line:
```
WEBHOOK_URL=http://localhost:5678/
```

Replace with (using the public URL from the user's checkpoint response):
```
WEBHOOK_URL=https://<PUBLIC_URL_FROM_USER>/
```

The trailing slash is REQUIRED — n8n uses WEBHOOK_URL as a base URL and appends paths to it. Missing slash causes malformed webhook URLs.

After updating .env, restart n8n to pick up the new WEBHOOK_URL:
```bash
cd D:/n8n && docker compose restart n8n
```

Wait 15 seconds for n8n to restart, then verify:
```bash
curl -s http://localhost:5678/healthz
# Should return {"status":"ok"}

docker exec n8n_app env | grep WEBHOOK_URL
# Must show: WEBHOOK_URL=https://your-public-domain.com/
```
  </action>
  <verify>
1. `docker exec n8n_app env | grep WEBHOOK_URL` — must show the HTTPS tunnel URL, not localhost
2. `curl -s http://localhost:5678/healthz` — returns `{"status":"ok"}` after restart
3. Open n8n UI at http://localhost:5678 → create a temporary Webhook node → the displayed webhook URL should start with `https://your-tunnel-domain.com/webhook/...` (not localhost). Delete the test node after confirming.
  </verify>
  <done>D:/n8n/.env has WEBHOOK_URL set to the real Cloudflare Tunnel HTTPS URL, n8n has restarted and reflects the correct public webhook URL in the UI.</done>
</task>

</tasks>

<verification>
End-to-end network hardening check:
1. `curl https://<PUBLIC_TUNNEL_URL>/` returns n8n HTTP response (tunnel live)
2. `docker exec n8n_app env | grep WEBHOOK_URL` shows HTTPS URL (not localhost)
3. Port isolation: `docker inspect n8n_app | grep -A5 Ports` shows `127.0.0.1:5678` binding (not 0.0.0.0)
4. External port scan: `nmap -p 5678 <your-external-ip>` from another machine shows port as filtered/closed (not open)
</verification>

<success_criteria>
- Cloudflare Tunnel is running and connected (cloudflared process or service active)
- https://n8n.yourdomain.com returns a valid n8n HTTP response
- D:/n8n/.env WEBHOOK_URL is updated to the real HTTPS tunnel URL with trailing slash
- Port 5678 is NOT directly reachable from outside the machine (loopback-only binding)
- n8n Webhook node UI shows the correct public tunnel URL, not localhost
</success_criteria>

<output>
After completion, create `D:/Projects/fhcontent-creator-v2/.planning/phases/01-infrastructure-foundation/01-02-SUMMARY.md` following the summary template. Record the public tunnel URL (without secrets) in the summary for reference by downstream plans.
</output>
