---
phase: 01-infrastructure-foundation
plan: "03"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - D:/n8n/n8n-service.xml
  - D:/n8n/winsw-install.ps1
autonomous: false
requirements:
  - INFRA-04
  - INFRA-08

must_haves:
  truths:
    - "n8n starts automatically after a full Windows reboot without manual intervention"
    - "WinSW service shows Status: Running when queried post-reboot"
    - "Windows power plan is set to High Performance (no sleep or hibernate)"
    - "Sleep and hibernate are disabled in power settings"
    - "After a reboot, both docker containers restart automatically"
  artifacts:
    - path: "D:/n8n/n8n-service.xml"
      provides: "WinSW service definition for docker compose up"
      contains: "docker"
    - path: "D:/n8n/winsw-install.ps1"
      provides: "Installation script for WinSW service and Windows power configuration"
      contains: "powercfg"
  key_links:
    - from: "WinSW n8n-service"
      to: "docker compose"
      via: "executable + arguments in n8n-service.xml pointing to docker"
      pattern: "docker compose"
    - from: "Windows power plan"
      to: "n8n execution continuity"
      via: "High Performance plan disables sleep that would kill running workflows"
      pattern: "SCHEME_MIN"
---

<objective>
Configure WinSW to run n8n's Docker Compose stack as a Windows service that auto-starts on boot, and set the Windows power plan to High Performance to prevent sleep from killing running workflow executions.

Purpose: Without WinSW, n8n does not survive Windows reboots — users must manually run `docker compose up -d` after every restart. Without disabling sleep, long-running media generation workflows are silently killed mid-execution and logged as "crashed" with no recovery. PM2 is explicitly NOT used — it is documented as unreliable on Windows (WS-1 in PITFALLS.md).

Output: WinSW service installed and running, Windows power plan set to High Performance.
</objective>

<execution_context>
@C:/Users/redle/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/redle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@D:/Projects/fhcontent-creator-v2/.planning/ROADMAP.md
@D:/Projects/fhcontent-creator-v2/.planning/STATE.md
@D:/Projects/fhcontent-creator-v2/.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Download WinSW and create service definition</name>
  <files>D:/n8n/n8n-service.xml</files>
  <action>
Step 1 — Download WinSW binary to D:/n8n/:
```bash
# Download WinSW v2 for Windows x64
curl -L "https://github.com/winsw/winsw/releases/download/v2.12.0/WinSW-x64.exe" -o "D:/n8n/n8n-service.exe"
```

Step 2 — Write D:/n8n/n8n-service.xml:

```xml
<service>
  <id>n8n-docker</id>
  <name>n8n Workflow Automation</name>
  <description>n8n 2.9.0 + PostgreSQL 15 via Docker Compose — auto-started on boot</description>

  <executable>docker</executable>
  <arguments>compose --project-directory D:\n8n up -d --wait</arguments>

  <workingdirectory>D:\n8n</workingdirectory>

  <!-- Startup: wait for Docker Desktop to be fully running -->
  <delayedAutoStart>true</delayedAutoStart>

  <!-- Recovery: restart service if it crashes -->
  <onfailure action="restart" delay="30 sec"/>
  <onfailure action="restart" delay="60 sec"/>
  <onfailure action="restart" delay="120 sec"/>
  <resetfailure>1 hour</resetfailure>

  <!-- Log rotation -->
  <log mode="roll-by-size">
    <sizeThreshold>10240</sizeThreshold>
    <keepFiles>5</keepFiles>
  </log>

  <!-- Stop: graceful shutdown -->
  <stopexecutable>docker</stopexecutable>
  <stoparguments>compose --project-directory D:\n8n down</stoparguments>
  <stoptimeout>30 sec</stoptimeout>
</service>
```

Key design decisions:
- `--wait` flag on `docker compose up` makes Docker Compose wait until containers are healthy before reporting success — prevents WinSW from thinking startup failed
- `delayedAutoStart` ensures Docker Desktop has time to initialize WSL2 before n8n tries to start
- Three recovery actions with increasing delays match WinSW best practices for service recovery
- Graceful stop via `docker compose down` — prevents PostgreSQL data corruption on shutdown

Note: WinSW runs docker.exe directly. Docker Desktop must be configured to "Start Docker Desktop when you log in" (Docker Desktop Settings → General). If Docker Desktop is not running when WinSW starts, docker compose will fail — WinSW recovery actions will retry.
  </action>
  <verify>
1. `ls D:/n8n/n8n-service.exe` — binary exists
2. `ls D:/n8n/n8n-service.xml` — XML config exists
3. Parse check: `"D:/n8n/n8n-service.exe" status` — may say "NonExistent" (not installed yet, which is expected at this step)
  </verify>
  <done>D:/n8n/n8n-service.exe and D:/n8n/n8n-service.xml exist, XML is valid WinSW config with recovery actions.</done>
</task>

<task type="auto">
  <name>Task 2: Create and run installation PowerShell script</name>
  <files>D:/n8n/winsw-install.ps1</files>
  <action>
Write D:/n8n/winsw-install.ps1:

```powershell
#Requires -RunAsAdministrator
# n8n Infrastructure Install Script
# Run once as Administrator to install WinSW service and configure Windows power settings

Write-Host "=== n8n Infrastructure Setup ===" -ForegroundColor Cyan

# 1. Install WinSW service
Write-Host "`n[1/4] Installing n8n WinSW service..." -ForegroundColor Yellow
Set-Location D:\n8n
.\n8n-service.exe install
if ($LASTEXITCODE -ne 0) {
    Write-Error "WinSW install failed. Ensure running as Administrator."
    exit 1
}
Write-Host "Service installed." -ForegroundColor Green

# 2. Start the service
Write-Host "`n[2/4] Starting service..." -ForegroundColor Yellow
.\n8n-service.exe start
Start-Sleep -Seconds 15  # Wait for docker compose up --wait to complete
$svc = Get-Service -Name "n8n-docker" -ErrorAction SilentlyContinue
if ($svc.Status -ne "Running") {
    Write-Warning "Service not running after start. Check D:\n8n\n8n-service.out.log"
} else {
    Write-Host "Service running." -ForegroundColor Green
}

# 3. Set Windows power plan to High Performance
Write-Host "`n[3/4] Configuring power plan (High Performance, no sleep)..." -ForegroundColor Yellow

# Activate High Performance plan
powercfg /setactive SCHEME_MIN
# Disable sleep (AC power)
powercfg /change standby-timeout-ac 0
# Disable hibernate
powercfg /hibernate off
# Disable monitor timeout (set to 60 min — keeps screen visible during long workflows)
powercfg /change monitor-timeout-ac 60

$activePlan = powercfg /getactivescheme
Write-Host "Active power scheme: $activePlan" -ForegroundColor Green

# 4. Verify Docker Desktop autostart
Write-Host "`n[4/4] Verifying Docker Desktop autostart..." -ForegroundColor Yellow
$dockerAutostart = Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "Docker Desktop" -ErrorAction SilentlyContinue
if ($dockerAutostart) {
    Write-Host "Docker Desktop autostart: already configured." -ForegroundColor Green
} else {
    Write-Warning "Docker Desktop autostart not found in registry."
    Write-Host "ACTION REQUIRED: Open Docker Desktop -> Settings -> General -> enable Start Docker Desktop when you log in" -ForegroundColor Red
}

Write-Host "`n=== Setup Complete ===" -ForegroundColor Cyan
Write-Host "n8n service status: $(& D:\n8n\n8n-service.exe status)" -ForegroundColor White
Write-Host "Active power scheme: $(powercfg /getactivescheme)" -ForegroundColor White
Write-Host "`nTo verify reboot behavior: restart Windows, then check n8n at http://localhost:5678" -ForegroundColor Yellow
```

Execute the script as Administrator:
```powershell
# In an elevated PowerShell prompt:
powershell -ExecutionPolicy Bypass -File "D:\n8n\winsw-install.ps1"
```

Wait for the script to complete. Read all output carefully — any warnings about Docker autostart must be addressed by enabling the setting in Docker Desktop → Settings → General before proceeding to the reboot test.
  </action>
  <verify>
After script runs:
1. `Get-Service -Name "n8n-docker"` in PowerShell — Status must be "Running"
2. `powercfg /getactivescheme` — must show "High Performance" (SCHEME_MIN)
3. `powercfg /query SCHEME_MIN SUB_SLEEP STANDBYIDLE` — ACSettingIndex should be 0 (sleep disabled on AC)
4. `docker ps` — should show both n8n_app and n8n_postgres as running
  </verify>
  <done>WinSW service n8n-docker is Running status, Windows power plan is High Performance, sleep on AC power is disabled, Docker containers are running.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Reboot test — verify autostart survives Windows restart</name>
  <action>
Human must perform a full Windows reboot to verify that WinSW auto-starts the Docker Compose stack without manual intervention. This cannot be automated — only a real reboot proves the service starts correctly on boot.

Steps:
1. Save any open work
2. Perform a full Windows restart (Start → Restart, not Shutdown)
3. After login, wait 2 minutes for Docker Desktop and WSL2 to initialize
4. Check http://localhost:5678 — n8n UI must load without manual intervention
5. Run `Get-Service "n8n-docker"` — must show Running
6. Run `docker ps` — both containers must be up
7. Run `powercfg /getactivescheme` — must show High Performance
  </action>
  <verify>
All 7 checks in the how-to-verify section must pass before marking this task complete:
1. http://localhost:5678 loads n8n UI
2. `Get-Service "n8n-docker"` shows Running
3. `docker ps` shows both n8n_app and n8n_postgres as Up
4. `powercfg /getactivescheme` shows High Performance
  </verify>
  <done>n8n UI reachable at http://localhost:5678 after a full Windows reboot with zero manual intervention, WinSW service is Running, both containers healthy, power plan is High Performance.</done>
  <what-built>
WinSW service n8n-docker installed to start docker compose up -d on boot, Windows power plan set to High Performance with sleep/hibernate disabled.
  </what-built>
  <how-to-verify>
1. Save any open work
2. Perform a full Windows restart (Start → Restart, not Shutdown)
3. After login, wait 2 minutes for Docker Desktop and WSL2 to initialize
4. Open a browser and navigate to http://localhost:5678
   - EXPECTED: n8n UI loads (setup page or login page)
   - FAIL: Connection refused or blank page
5. Open PowerShell and run: `Get-Service -Name "n8n-docker"`
   - EXPECTED: Status = Running
   - FAIL: Status = Stopped
6. Run: `docker ps`
   - EXPECTED: Both n8n_app and n8n_postgres shown as "Up X minutes"
   - FAIL: No containers or one container missing
7. Run: `powercfg /getactivescheme`
   - EXPECTED: "High Performance" scheme shown
   - FAIL: "Balanced" or other scheme
  </how-to-verify>
  <resume-signal>Type "reboot-passed" if all 7 checks pass, or describe which step failed and what you observed.</resume-signal>
</task>

</tasks>

<verification>
Post-reboot state verification:
1. `Get-Service "n8n-docker"` — Running
2. `docker ps --format "table {{.Names}}\t{{.Status}}"` — both containers up
3. `curl -s http://localhost:5678/healthz` — returns {"status":"ok"}
4. `powercfg /getactivescheme` — shows High Performance
5. `powercfg /query SCHEME_MIN SUB_SLEEP STANDBYIDLE | findstr "ACSettingIndex"` — shows 0x00000000
</verification>

<success_criteria>
- WinSW service "n8n-docker" installed and auto-starts after Windows reboot
- Docker Compose stack restarts automatically (both containers healthy) after reboot
- Windows power plan is High Performance
- Sleep on AC power is disabled (standby timeout = 0)
- Hibernate is disabled
- Human verified: n8n UI is reachable at http://localhost:5678 after a fresh Windows restart with no manual intervention
</success_criteria>

<output>
After completion, create `D:/Projects/fhcontent-creator-v2/.planning/phases/01-infrastructure-foundation/01-03-SUMMARY.md` following the summary template.
</output>
