---
phase: 01-infrastructure-foundation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - D:/n8n/docker-compose.yml
  - D:/n8n/.env
  - D:/Projects/fhcontent-creator-v2/n8n-workflows/README.md
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-06
  - INFRA-07
  - SEC-01

must_haves:
  truths:
    - "docker compose up -d starts without errors and both containers reach healthy state"
    - "n8n UI is reachable at http://localhost:5678"
    - "n8n version inside the container is 2.9.0 (above CVE-2026-21858 threshold of 1.120.4)"
    - "PostgreSQL 15 container is healthy and n8n connects to it (not SQLite)"
    - "Schedule Triggers fire in America/New_York timezone (both TZ and GENERIC_TIMEZONE set)"
    - "Execution pruning is active (7-day retention, prevents DB bloat)"
  artifacts:
    - path: "D:/n8n/docker-compose.yml"
      provides: "Service definitions for n8n 2.9.0 and PostgreSQL 15"
      contains: "n8nio/n8n:2.9.0"
    - path: "D:/n8n/.env"
      provides: "All environment variables for n8n system config"
      contains: "N8N_ENCRYPTION_KEY"
    - path: "D:/Projects/fhcontent-creator-v2/n8n-workflows/README.md"
      provides: "Credential names inventory and workflow version control instructions"
  key_links:
    - from: "D:/n8n/docker-compose.yml"
      to: "D:/n8n/.env"
      via: "env_file directive"
      pattern: "env_file"
    - from: "n8n container"
      to: "postgres container"
      via: "DB_POSTGRESDB_HOST=postgres service name"
      pattern: "DB_POSTGRESDB_HOST=postgres"
---

<objective>
Create the Docker Compose stack that runs n8n 2.9.0 with PostgreSQL 15 as its backing database, with all required environment variables set before first launch.

Purpose: Every subsequent workflow, credential, and security control depends on this foundation being correct. The N8N_ENCRYPTION_KEY must be set before the first launch — it cannot be changed retroactively without destroying all stored credentials. PostgreSQL must be in place before any cron workflow fires or SQLITE_BUSY errors will occur.

Output: D:/n8n/docker-compose.yml, D:/n8n/.env, n8n-workflows/ directory scaffolded with README.
</objective>

<execution_context>
@C:/Users/redle/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/redle/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@D:/Projects/fhcontent-creator-v2/.planning/PROJECT.md
@D:/Projects/fhcontent-creator-v2/.planning/ROADMAP.md
@D:/Projects/fhcontent-creator-v2/.planning/STATE.md
@D:/Projects/fhcontent-creator-v2/.planning/research/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create D:/n8n/ directory with docker-compose.yml and .env</name>
  <files>D:/n8n/docker-compose.yml</files>
  <action>
Create the directory D:/n8n/ and write the following docker-compose.yml exactly:

```yaml
version: "3.8"

services:
  postgres:
    image: postgres:15
    container_name: n8n_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_POSTGRESDB_DATABASE}
      POSTGRES_USER: ${DB_POSTGRESDB_USER}
      POSTGRES_PASSWORD: ${DB_POSTGRESDB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_POSTGRESDB_USER} -d ${DB_POSTGRESDB_DATABASE}"]
      interval: 5s
      timeout: 5s
      retries: 5

  n8n:
    image: docker.n8n.io/n8nio/n8n:2.9.0
    container_name: n8n_app
    restart: unless-stopped
    ports:
      - "127.0.0.1:5678:5678"
    env_file:
      - .env
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data:
  n8n_data:
```

Key design decisions embedded here:
- Port binding is `127.0.0.1:5678:5678` (loopback only — SEC-04: port 5678 NOT exposed to public internet, only Cloudflare Tunnel reaches it)
- Image pinned to `docker.n8n.io/n8nio/n8n:2.9.0` (NOT `latest` — prevents accidental breaking upgrades)
- Named Docker volumes (NOT host path mounts — avoids Windows permission issues on D:\ drive)
- PostgreSQL health check with `depends_on condition: service_healthy` — n8n will not start until Postgres is ready

Do NOT use `0.0.0.0:5678:5678` — that would expose the port publicly.
Do NOT use `image: n8nio/n8n:latest` — version must be pinned.
  </action>
  <verify>
Run: `docker compose -f D:/n8n/docker-compose.yml config` — should output valid YAML with no errors.
Check port binding: output must show `127.0.0.1:5678` not `0.0.0.0:5678`.
  </verify>
  <done>docker-compose.yml exists at D:/n8n/docker-compose.yml, passes `docker compose config`, port is loopback-only.</done>
</task>

<task type="auto">
  <name>Task 2: Create .env file with all required n8n system variables</name>
  <files>D:/n8n/.env</files>
  <action>
Generate a cryptographically random 64-character hex string for N8N_ENCRYPTION_KEY using:
  `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`

Generate a separate random string for N8N_USER_MANAGEMENT_JWT_SECRET using:
  `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`

Generate a strong PostgreSQL password using:
  `node -e "console.log(require('crypto').randomBytes(16).toString('hex'))"`

Write D:/n8n/.env with these values substituted:

```env
# n8n System Config — DO NOT COMMIT THIS FILE
# N8N_ENCRYPTION_KEY: set before first launch, never change after credentials are stored
N8N_ENCRYPTION_KEY=<generated-64-char-hex>
N8N_USER_MANAGEMENT_JWT_SECRET=<generated-random-string>

# Database — PostgreSQL 15
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=postgres
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8n
DB_POSTGRESDB_PASSWORD=<generated-strong-password>

# Timezone — BOTH must be set and must match (n8n 2.x requires both)
TZ=America/New_York
GENERIC_TIMEZONE=America/New_York

# Webhook URL — set to Cloudflare Tunnel URL after Plan 02 completes
# PLACEHOLDER: Update this value after cloudflared tunnel is created in Plan 01-02
WEBHOOK_URL=http://localhost:5678/

# Execution pruning — prevents database bloat killing query performance
EXECUTIONS_DATA_PRUNE=true
EXECUTIONS_DATA_MAX_AGE=168

# Node.js heap — prevents OOM crash during parallel media workflow executions
NODE_OPTIONS=--max-old-space-size=4096

# Payload size — AI-generated content can exceed 16MB default
N8N_PAYLOAD_SIZE_MAX=512

# Security defaults (n8n 2.x) — Code nodes cannot access process.env
# N8N_BLOCK_ENV_ACCESS_IN_NODE=true (this is the default, no need to set)
```

CRITICAL: After writing the file, immediately save the value of N8N_ENCRYPTION_KEY to a note or password manager entry. If this value is lost and credentials have been saved, all n8n credentials are permanently unrecoverable.

Note: WEBHOOK_URL is set to localhost placeholder now. Plan 01-02 (Cloudflare Tunnel) will update this to the real tunnel URL before any webhooks are tested.

Do NOT put Supabase keys, Claude API keys, HeyGen API keys, or any workflow-level secrets in this file. Those belong in the n8n Credential Store (Plan 01-04).
  </action>
  <verify>
Run: `docker compose --env-file D:/n8n/.env config` from D:/n8n/ — should substitute all variables without "variable is not set" warnings.
Check: `grep -c "CHANGE_ME\|TODO\|placeholder" D:/n8n/.env` should return 0.
Confirm N8N_ENCRYPTION_KEY is exactly 64 hex chars: `grep N8N_ENCRYPTION_KEY D:/n8n/.env | cut -d= -f2 | wc -c` should return 65 (64 chars + newline).
  </verify>
  <done>.env exists at D:/n8n/.env with all required variables set, no placeholder values remaining (except WEBHOOK_URL which is intentionally localhost pending Plan 01-02), N8N_ENCRYPTION_KEY is 64 hex chars.</done>
</task>

<task type="auto">
  <name>Task 3: Start the stack, verify health, scaffold n8n-workflows directory</name>
  <files>D:/Projects/fhcontent-creator-v2/n8n-workflows/README.md</files>
  <action>
Step 1 — Start the Docker stack:
```bash
cd D:/n8n && docker compose up -d
```

Step 2 — Wait for both containers to be healthy (up to 60 seconds):
```bash
docker compose ps
# Both should show "running" with postgres showing "healthy"
```

Step 3 — Verify n8n version inside the container:
```bash
docker exec n8n_app n8n --version
# Must output 2.9.0 — confirms CVE-2026-21858 patch (threshold: 1.120.4)
```

Step 4 — Verify PostgreSQL is the backing database (not SQLite):
```bash
docker exec n8n_app env | grep DB_TYPE
# Must output: DB_TYPE=postgresdb
```

Step 5 — Verify n8n UI is reachable:
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:5678/
# Must return 200 or 301 (redirect to setup page)
```

Step 6 — Create n8n-workflows/ directory in the project with README:

Create D:/Projects/fhcontent-creator-v2/n8n-workflows/ directory and write README.md:

```markdown
# n8n Workflow Version Control

Workflow JSON files are exported from n8n UI and committed here. They contain node configurations and credential references (names/IDs only — no secret values). Safe to commit.

## Export Instructions
1. Open workflow in n8n UI
2. Top-right menu (...) → Export → JSON
3. Save to this directory as `{workflow-name}.json`
4. Commit to git

## Credentials Required (names only — values in n8n Credential Store)
When importing workflows to a new n8n instance, recreate these credentials by name:

| Credential Name | Type | Service |
|----------------|------|---------|
| Supabase Service Role | Supabase API | Project `qjpujskwqaehxnqypxzu` |
| Supabase Anon Key | HTTP Header Auth | Project `qjpujskwqaehxnqypxzu` |
| Claude API | HTTP Header Auth | Anthropic |
| HeyGen API | HTTP Header Auth | HeyGen |
| Blotato API | HTTP Header Auth | Blotato |
| ElevenLabs API | HTTP Header Auth | ElevenLabs |
| Gemini API | HTTP Header Auth | Google |
| OpenAI API | HTTP Header Auth | OpenAI |
| Canva API | HTTP Header Auth | Canva |

## Environment Variables Required on New Instance
See D:/n8n/.env for all required n8n system config values.
CRITICAL: N8N_ENCRYPTION_KEY must match the original value — stored in password manager.

## Workflow Inventory
| File | Workflow | Phase |
|------|----------|-------|
| (populated as workflows are created) | | |
```

Do NOT add D:/n8n/.env to git. Only n8n-workflows/ JSON files and README are committed.
  </action>
  <verify>
Run all verification commands from Step 1-5 above.
Confirm: `docker ps --format "table {{.Names}}\t{{.Status}}"` shows both `n8n_app` (running) and `n8n_postgres` (healthy).
Confirm: `docker exec n8n_app n8n --version` outputs `2.9.0`.
Confirm: `ls D:/Projects/fhcontent-creator-v2/n8n-workflows/README.md` exists.
  </verify>
  <done>Both containers running and healthy, n8n version confirmed as 2.9.0, n8n UI responds at localhost:5678, n8n-workflows/README.md exists with credential inventory.</done>
</task>

</tasks>

<verification>
Full stack verification:
1. `docker compose -f D:/n8n/docker-compose.yml ps` — both containers show healthy/running
2. `docker exec n8n_app n8n --version` — returns `2.9.0`
3. `curl -s http://localhost:5678/` — returns non-error HTTP response
4. `docker exec n8n_app env | grep -E "DB_TYPE|TZ|GENERIC_TIMEZONE|EXECUTIONS_DATA_PRUNE"` — all four vars visible with correct values
5. `docker exec n8n_postgres psql -U n8n -d n8n -c "\dt"` — connects and lists n8n tables (proves PostgreSQL is wired, not SQLite)
</verification>

<success_criteria>
- D:/n8n/docker-compose.yml exists, uses pinned image 2.9.0, port bound to 127.0.0.1 only
- D:/n8n/.env exists with all 10+ variables set, N8N_ENCRYPTION_KEY is 64 hex chars
- Both Docker containers running: n8n_app and n8n_postgres (healthy)
- n8n --version confirms 2.9.0 inside container (above CVE-2026-21858 threshold)
- PostgreSQL is the database backend (DB_TYPE=postgresdb confirmed in container env)
- n8n UI responds at http://localhost:5678
- n8n-workflows/README.md committed to project repo with credential name inventory
</success_criteria>

<output>
After completion, create `D:/Projects/fhcontent-creator-v2/.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md` following the summary template.
</output>
